<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å…¨å“¡ã®çµæœä¸€è¦§</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #000;
      color: #ffeb3b;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 20px;
      text-shadow: 0 0 10px #ffeb3b;
      letter-spacing: 2px;
    }

    .correct-box {
      width: 95%;
      max-width: 600px;
      margin: 0 auto 25px auto;
      background: #111;
      border: 3px solid #ffeb3b;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
      font-size: 1.3em;
    }

    .rank-line {
      font-size: 1.5em;
      margin: 8px 0;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease-out;
    }

    .rank-line.show {
      opacity: 1;
      transform: translateY(0);
    }

    .board {
      width: 95%;
      max-width: 600px;
      margin: 0 auto;
      background: #111;
      border: 3px solid #ffeb3b;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
    }

    .item {
      border-bottom: 1px solid #555;
      padding: 12px 5px;
      text-align: left;
      opacity: 0;
      transform: translateY(20px);
      animation: show 0.6s forwards;
    }

    @keyframes show {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hit {
      color: #ffeb3b;
      font-weight: bold;
      text-shadow: 0 0 8px #ffeb3b;
    }

    .miss {
      color: #ff5252;
      font-weight: bold;
      text-shadow: 0 0 8px #ff5252;
    }

    .btn-area {
      margin-top: 25px;
    }

    .btn {
      padding: 12px 25px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
      margin: 10px;
    }

    .btn-danger {
      background: #ff5252;
      color: #fff;
      box-shadow: 0 0 10px #ff5252;
    }
  </style>
</head>
<body>

  <h1>ğŸ‡ å…¨å“¡ã®çµæœä¸€è¦§</h1>

  <!-- âœ… æ­£è§£ã®3é€£å˜ï¼ˆå®Ÿéš›ã®ç€é †ï¼‰ã‚’æœ€ä¸Šéƒ¨ã«è¡¨ç¤º -->
  <div class="correct-box">
    <h2>ğŸ¯ æ­£è§£ã®3é€£å˜</h2>
    <div id="correct1" class="rank-line">1ç€ï¼š</div>
    <div id="correct2" class="rank-line">2ç€ï¼š</div>
    <div id="correct3" class="rank-line">3ç€ï¼š</div>
  </div>

  <div class="board" id="resultBoard"></div>

  <div class="btn-area">
    <button class="btn" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    <button class="btn btn-danger" onclick="clearHistory()">å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>
  </div>

  <script>
    function getPlayerValue(id) {
      const v = localStorage.getItem("player_" + id + "_value");
      return v ? parseInt(v, 10) : 5;
    }

    // âœ… åŒç€å¯¾å¿œã®æœ€å¼·åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    function isHitWithTies(pred, actual, values) {
      const v = {};
      values.forEach(p => v[p.id] = p.value);

      // 1ä½ãƒ»2ä½ãŒåŒç€
      if (v[actual[0]] === v[actual[1]]) {
        const setPred = new Set([pred[0], pred[1]]);
        const setActual = new Set([actual[0], actual[1]]);
        const ok12 = [...setPred].every(x => setActual.has(x));
        return ok12 && pred[2] === actual[2];
      }

      // 2ä½ãƒ»3ä½ãŒåŒç€
      if (v[actual[1]] === v[actual[2]]) {
        if (pred[0] !== actual[0]) return false;
        const setPred = new Set([pred[1], pred[2]]);
        const setActual = new Set([actual[1], actual[2]]);
        return [...setPred].every(x => setActual.has(x));
      }

      // å…¨éƒ¨åŒç€
      if (v[actual[0]] === v[actual[1]] && v[actual[1]] === v[actual[2]]) {
        const setPred = new Set(pred);
        const setActual = new Set(actual);
        return [...setPred].every(x => setActual.has(x));
      }

      // é€šå¸¸ã®3é€£å˜
      return (
        pred[0] === actual[0] &&
        pred[1] === actual[1] &&
        pred[2] === actual[2]
      );
    }

    function loadAllResults() {
      const history = JSON.parse(localStorage.getItem("trifecta_history") || "[]");
      const board = document.getElementById("resultBoard");

      const count = parseInt(localStorage.getItem("playerCount") || "3", 10);
      const values = [];
      for (let i = 1; i <= count; i++) {
        values.push({ id: i, value: getPlayerValue(i) });
      }

      values.sort((a, b) => b.value - a.value);

      const actual1 = values[0].id;
      const actual2 = values[1].id;
      const actual3 = values[2].id;

      const v1 = values[0].value;
      const v2 = values[1].value;
      const v3 = values[2].value;

      // âœ… æ­£è§£ã®3é€£å˜ã‚’æœ€ä¸Šéƒ¨ã«è¡¨ç¤º
      document.getElementById("correct1").textContent =
        `1ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual1} ${v1===v2 ? "ï¼ˆåŒç€ï¼‰" : ""}`;
      document.getElementById("correct2").textContent =
        `2ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual2} ${v2===v3 || v1===v2 ? "ï¼ˆåŒç€ï¼‰" : ""}`;
      document.getElementById("correct3").textContent =
        `3ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual3} ${v2===v3 ? "ï¼ˆåŒç€ï¼‰" : ""}`;

      setTimeout(() => document.getElementById("correct1").classList.add("show"), 200);
      setTimeout(() => document.getElementById("correct2").classList.add("show"), 600);
      setTimeout(() => document.getElementById("correct3").classList.add("show"), 1000);

      // âœ… çš„ä¸­è€…ã‚’ä¸Šã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ä¸¦ã¹æ›¿ãˆ
      const sortedHistory = history
        .map(h => {
          const predicted = [Number(h.first), Number(h.second), Number(h.third)];
          const actual = [actual1, actual2, actual3];
          const hit = isHitWithTies(predicted, actual, values);
          return { ...h, hit };
        })
        .sort((a, b) => b.hit - a.hit); // âœ… çš„ä¸­è€…ãŒä¸Š

      board.innerHTML = "";

      sortedHistory.forEach((h, index) => {
        const div = document.createElement("div");
        div.className = "item";
        div.style.animationDelay = `${0.1 * index}s`;

        div.innerHTML = `
          <strong>${h.name}</strong><br>
          äºˆæƒ³ï¼š${h.first} â†’ ${h.second} â†’ ${h.third}<br>

          <div class="rank-block">
            <strong>å®Ÿéš›ã®ç€é †</strong><br>
            1ç€ï¼š${actual1} ${v1===v2 ? "ï¼ˆåŒç€ï¼‰" : ""}<br>
            2ç€ï¼š${actual2} ${v2===v3 || v1===v2 ? "ï¼ˆåŒç€ï¼‰" : ""}<br>
            3ç€ï¼š${actual3} ${v2===v3 ? "ï¼ˆåŒç€ï¼‰" : ""}<br>
          </div>

          <span class="${h.hit ? "hit" : "miss"}">
            ${h.hit ? "ğŸ‰ çš„ä¸­ï¼" : "âŒ ãƒã‚ºãƒ¬"}
          </span>
        `;

        board.appendChild(div);
      });
    }

    function clearHistory() {
      if (!confirm("æœ¬å½“ã«å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      localStorage.removeItem("trifecta_history");
      loadAllResults();
    }

    loadAllResults();
  </script>

</body>
</html>
