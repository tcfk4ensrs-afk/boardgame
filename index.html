<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3é€£å˜ã‚²ãƒ¼ãƒ  - ãƒ›ãƒ¼ãƒ ï¼ˆFirebaseç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b3d0b;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    h1 {
      font-size: 2.2em;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      margin-bottom: 20px;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .section {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      margin: 15px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      border: 2px solid #ffeb3b;
      box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-size: 1.1em;
      font-weight: bold;
    }
    input[type="number"] {
      width: 120px;
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 1.1em;
      text-align: center;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
    }
    button:disabled {
      background: #777;
      color: #333;
      box-shadow: none;
      cursor: not-allowed;
    }
    .player-card {
      background: #1b5e20;
      padding: 12px;
      margin: 10px auto;
      border-radius: 8px;
      width: 85%;
      max-width: 450px;
      border-left: 6px solid #ffeb3b;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
      font-size: 1.2em;
      text-align: left;
      padding-left: 20px;
    }
  </style>
</head>
<body>

  <h1>ğŸ‡ 3é€£å˜ã‚²ãƒ¼ãƒ ï¼ˆFirebaseç‰ˆï¼‰</h1>

  <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°è¨­å®š -->
  <div class="section">
    <label>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°</label>
    <input type="number" id="playerCount" min="1" max="20">
    <button id="savePlayerCount">äººæ•°ã‚’ç¢ºå®š</button>
    <p id="playerCountDisplay" style="margin-top:10px;"></p>
  </div>

  <!-- ä¸Šé™å€¤è¨­å®š -->
  <div class="section">
    <label>åˆè¨ˆæ•°å­—ã®ä¸Šé™å€¤</label>
    <input type="number" id="maxTotal" min="1">
    <button id="saveMaxTotal">ä¸Šé™ã‚’ç¢ºå®š</button>
    <p id="maxTotalDisplay" style="margin-top:10px;"></p>
  </div>

  <!-- åˆè¨ˆå€¤è¡¨ç¤º -->
  <div class="section">
    <p>ç¾åœ¨ã®åˆè¨ˆå€¤ï¼š<span id="currentTotal">-</span></p>
    <p id="maxTotalLabel"></p>
  </div>

  <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ -->
  <div id="playerList"></div>

  <!-- ãƒªã‚»ãƒƒãƒˆ -->
  <div class="section">
    <button id="resetBtn">ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆäººæ•°ãƒ»ä¸Šé™ï¼‰</button>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      onSnapshot, collection, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* Firebase è¨­å®š */
    const firebaseConfig = {
      apiKey: "AIzaSyA60JGwkkQ4HbN6G7yPqhK_tPXFVE7GA0U",
      authDomain: "sanrentan-6adc0.firebaseapp.com",
      projectId: "sanrentan-6adc0",
      storageBucket: "sanrentan-6adc0.firebasestorage.app",
      messagingSenderId: "920208181022",
      appId: "1:920208181022:web:bb3a050055fb9a40782b0f",
      measurementId: "G-43N8MYJW96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const settingsRef = doc(db, "settings", "global");
    const playersCol = collection(db, "players");
    const historyCol = collection(db, "history");   // â† æ­£ã—ã„ä½ç½®
    const trifectaCol = collection(db, "trifecta");

    /* Firestore è¨­å®šã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€ */
    onSnapshot(settingsRef, (snap) => {
      if (!snap.exists()) return;

      const data = snap.data();

      document.getElementById("playerCount").value = data.playerCount;
      document.getElementById("maxTotal").value = data.maxTotal;

      document.getElementById("playerCountDisplay").textContent =
        `ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ï¼š${data.playerCount}äºº`;

      document.getElementById("maxTotalDisplay").textContent =
        `ç¾åœ¨ã®ä¸Šé™å€¤ï¼š${data.maxTotal}`;

      renderPlayers(data.playerCount);
      updateTotalDisplay();
    });

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤º */
    async function renderPlayers(count) {
      const list = document.getElementById("playerList");
      list.innerHTML = "";

      for (let i = 1; i <= count; i++) {
        const div = document.createElement("div");
        div.className = "player-card";
        div.innerHTML = `
          <strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}</strong><br>
          <a href="${i}.html" target="_blank">â–¶ è©³ç´°ãƒšãƒ¼ã‚¸ã¸</a>
        `;
        list.appendChild(div);
      }
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤å–å¾— */
    async function getPlayerValue(id) {
      const ref = doc(db, "players", String(id));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data().value : 5;
    }

    /* åˆè¨ˆå€¤è¡¨ç¤º */
    async function updateTotalDisplay() {
      const settingsSnap = await getDoc(settingsRef);
      if (!settingsSnap.exists()) return;

      const { playerCount, maxTotal } = settingsSnap.data();

      let total = 0;
      for (let i = 1; i <= playerCount; i++) {
        total += await getPlayerValue(i);
      }

      document.getElementById("currentTotal").textContent = total;
      document.getElementById("maxTotalLabel").textContent = `ä¸Šé™ï¼š${maxTotal}`;
    }

    /* äººæ•°ç¢ºå®šï¼ˆãƒ­ãƒƒã‚¯ï¼‰ */
    document.getElementById("savePlayerCount").onclick = async () => {
      const count = Number(document.getElementById("playerCount").value);
      await updateDoc(settingsRef, {
        playerCount: count,
        lockPlayerCount: true
      });
    };

    /* ä¸Šé™ç¢ºå®šï¼ˆãƒ­ãƒƒã‚¯ï¼‰ */
    document.getElementById("saveMaxTotal").onclick = async () => {
      const max = Number(document.getElementById("maxTotal").value);
      await updateDoc(settingsRef, {
        maxTotal: max,
        lockMaxTotal: true
      });
    };

    /* ãƒ­ãƒƒã‚¯è§£é™¤ + å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ */
    document.getElementById("resetBtn").onclick = async () => {
      if (!confirm("äººæ•°ãƒ»ä¸Šé™å€¤ã®ãƒ­ãƒƒã‚¯è§£é™¤ã¨ã€å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ")) return;

      const settingsSnap = await getDoc(settingsRef);
      const count = settingsSnap.data().playerCount;

      /* 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å€¤ã‚’ã™ã¹ã¦ 5 ã«æˆ»ã™ */
      for (let i = 1; i <= count; i++) {
        await setDoc(doc(db, "players", String(i)), { value: 5 });
      }

      /* 2. history ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨å‰Šé™¤ */
      const historySnap = await getDocs(historyCol);
      for (const d of historySnap.docs) {
        await deleteDoc(doc(db, "history", d.id));
      }

      /* 3. trifecta ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨å‰Šé™¤ */
      const trifectaSnap = await getDocs(trifectaCol);
      for (const d of trifectaSnap.docs) {
        await deleteDoc(doc(db, "trifecta", d.id));
      }

      /* 4. settings ã®ãƒ­ãƒƒã‚¯è§£é™¤ */
      await updateDoc(settingsRef, {
        lockPlayerCount: false,
        lockMaxTotal: false
      });

      alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã€ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ");
    };

  </script>

</body>
</html>
