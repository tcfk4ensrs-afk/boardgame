<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>プレイヤー1</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 5px; padding: 8px 12px; }
  </style>
</head>
<body>
  <h1>プレイヤー1</h1>

  <div>
    <p>現在の値：<span id="currentValue">-</span></p>
    <p>現在の順位：<span id="currentRank">-</span></p>
  </div>

  <div>
    <p>値を変更：</p>
    <button data-diff="-3">-3</button>
    <button data-diff="-2">-2</button>
    <button data-diff="-1">-1</button>
    <button data-diff="1">+1</button>
    <button data-diff="3">+3</button>
    <button data-diff="10">+10</button>
  </div>

  <script>
    const PLAYER_ID = 1;
    const DEFAULT_VALUE = 5;
    const PLAYER_COUNT_KEY = "playerCount";

    function getPlayerValue(playerId) {
      const key = "player_" + playerId + "_value";
      const stored = localStorage.getItem(key);
      if (stored === null) return DEFAULT_VALUE;
      return parseInt(stored, 10);
    }

    function setPlayerValue(playerId, value) {
      const key = "player_" + playerId + "_value";
      localStorage.setItem(key, String(value));
    }

    function loadPlayerValue() {
      const value = getPlayerValue(PLAYER_ID);
      document.getElementById("currentValue").textContent = value;
    }

    function calcRank() {
      const count = parseInt(localStorage.getItem(PLAYER_COUNT_KEY) || "3", 10);
      const values = [];
      for (let i = 1; i <= count; i++) {
        values.push(getPlayerValue(i));
      }
      const sorted = [...values].sort((a, b) => b - a); // 大きい順
      const myValue = getPlayerValue(PLAYER_ID);
      const index = sorted.indexOf(myValue);
      const rank = index + 1;
      document.getElementById("currentRank").textContent = rank + "位 / " + count + "人中";
    }

    function updateAndRank() {
      loadPlayerValue();
      calcRank();
    }

    function scheduleCloseTab() {
      setTimeout(() => {
        window.close();
      }, 5000);
    }

    function onButtonClick(diff) {
      const current = getPlayerValue(PLAYER_ID);
      const next = current + diff;
      setPlayerValue(PLAYER_ID, next);
      updateAndRank();
      scheduleCloseTab();
    }

    document.querySelectorAll("button[data-diff]").forEach(btn => {
      btn.addEventListener("click", () => {
        const diff = parseInt(btn.getAttribute("data-diff"), 10);
        onButtonClick(diff);
      });
    });

    updateAndRank();
  </script>
</body>
</html>
