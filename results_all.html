<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å…¨å“¡ã®çµæœä¸€è¦§ï¼ˆæ®µéšå…¬é–‹ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #000;
      color: #ffeb3b;
      padding: 20px;
      text-align: center;
      user-select: none;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 20px;
      text-shadow: 0 0 10px #ffeb3b;
      letter-spacing: 2px;
    }

    .correct-box {
      width: 95%;
      max-width: 600px;
      margin: 0 auto 25px auto;
      background: #111;
      border: 3px solid #ffeb3b;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
      font-size: 1.3em;
    }

    .rank-line {
      font-size: 1.5em;
      margin: 8px 0;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease-out;
    }

    .rank-line.show {
      opacity: 1;
      transform: translateY(0);
    }

    .board {
      width: 95%;
      max-width: 600px;
      margin: 40px auto 0 auto;
      background: #111;
      border: 3px solid #ffeb3b;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
      display: none;
    }

    .item {
      border-bottom: 1px solid #555;
      padding: 12px 5px;
      text-align: left;
      opacity: 0;
      transform: translateY(20px);
      animation: show 0.6s forwards;
    }

    @keyframes show {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hit {
      color: #ffeb3b;
      font-weight: bold;
      text-shadow: 0 0 8px #ffeb3b;
    }

    .miss {
      color: #ff5252;
      font-weight: bold;
      text-shadow: 0 0 8px #ff5252;
    }

    .btn-area {
      margin-top: 25px;
    }

    .btn {
      padding: 12px 25px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
      margin: 10px;
    }

    .btn-danger {
      background: #ff5252;
      color: #fff;
      box-shadow: 0 0 10px #ff5252;
    }
  </style>
</head>
<body>

  <h1>ğŸ‡ å…¨å“¡ã®çµæœä¸€è¦§</h1>

  <!-- âœ… æ­£è§£ã®3é€£å˜ï¼ˆæ®µéšå…¬é–‹ï¼‰ -->
  <div class="correct-box" id="correctBox">
    <h2>ğŸ¯ æ­£è§£ã®3é€£å˜</h2>
    <div id="rank3" class="rank-line">3ç€ï¼š</div>
    <div id="rank2" class="rank-line">2ç€ï¼š</div>
    <div id="rank1" class="rank-line">1ç€ï¼š</div>
  </div>

  <div class="board" id="resultBoard"></div>

  <div class="btn-area">
    <button class="btn" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    <button class="btn btn-danger" onclick="clearHistory()">å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>
  </div>

  <!-- âœ… Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* âœ… Firebase è¨­å®š */
    const firebaseConfig = {
      apiKey: "AIzaSyA60JGwkkQ4HbN6G7yPqhK_tPXFVE7GA0U",
      authDomain: "sanrentan-6adc0.firebaseapp.com",
      projectId: "sanrentan-6adc0",
      storageBucket: "sanrentan-6adc0.firebasestorage.app",
      messagingSenderId: "920208181022",
      appId: "1:920208181022:web:bb3a050055fb9a40782b0f",
      measurementId: "G-43N8MYJW96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const settingsRef = doc(db, "settings", "global");
    const playersCol = collection(db, "players");
    const trifectaCol = collection(db, "trifecta");

    /* âœ… åŒç€å¯¾å¿œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãã®ã¾ã¾ä½¿ç”¨ï¼‰ */
    function isHitWithTies(pred, actual, values) {
      const v = {};
      values.forEach(p => v[p.id] = p.value);

      if (v[actual[0]] === v[actual[1]]) {
        const setPred = new Set([pred[0], pred[1]]);
        const setActual = new Set([actual[0], actual[1]]);
        const ok12 = [...setPred].every(x => setActual.has(x));
        return ok12 && pred[2] === actual[2];
      }

      if (v[actual[1]] === v[actual[2]]) {
        if (pred[0] !== actual[0]) return false;
        const setPred = new Set([pred[1], pred[2]]);
        const setActual = new Set([actual[1], actual[2]]);
        return [...setPred].every(x => setActual.has(x));
      }

      if (v[actual[0]] === v[actual[1]] && v[actual[1]] === v[actual[2]]) {
        const setPred = new Set(pred);
        const setActual = new Set(actual);
        return [...setPred].every(x => setActual.has(x));
      }

      return (
        pred[0] === actual[0] &&
        pred[1] === actual[1] &&
        pred[2] === actual[2]
      );
    }

    /* âœ… Firestore ã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ */
    async function loadAllResults() {
      const board = document.getElementById("resultBoard");

      /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°å–å¾— */
      const settingsSnap = await getDoc(settingsRef);
      const playerCount = settingsSnap.data().playerCount;

      /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤å–å¾— */
      const values = [];
      const playersSnap = await getDocs(playersCol);
      playersSnap.forEach(doc => {
        values.push({ id: Number(doc.id), value: doc.data().value });
      });

      values.sort((a, b) => b.value - a.value);

      const actual1 = values[0].id;
      const actual2 = values[1].id;
      const actual3 = values[2].id;

      const v1 = values[0].value;
      const v2 = values[1].value;
      const v3 = values[2].value;

      /* âœ… æ­£è§£ã®3é€£å˜ï¼ˆæ®µéšå…¬é–‹ç”¨ã«ã‚»ãƒƒãƒˆï¼‰ */
      document.getElementById("rank3").textContent =
        `3ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual3} ${v2===v3 ? "ï¼ˆåŒç€ï¼‰" : ""}`;
      document.getElementById("rank2").textContent =
        `2ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual2} ${v1===v2 || v2===v3 ? "ï¼ˆåŒç€ï¼‰" : ""}`;
      document.getElementById("rank1").textContent =
        `1ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual1} ${v1===v2 ? "ï¼ˆåŒç€ï¼‰" : ""}`;

      /* âœ… 3é€£å˜äºˆæƒ³ã‚’å–å¾— */
      const trifectaSnap = await getDocs(trifectaCol);
      const history = [];
      trifectaSnap.forEach(doc => history.push(doc.data()));

      /* âœ… çš„ä¸­åˆ¤å®š */
      const sortedHistory = history
        .map(h => {
          const predicted = [Number(h.first), Number(h.second), Number(h.third)];
          const actual = [actual1, actual2, actual3];
          const hit = isHitWithTies(predicted, actual, values);
          return { ...h, hit };
        })
        .sort((a, b) => b.hit - a.hit);

      /* âœ… çµæœä¸€è¦§ã‚’ç”Ÿæˆï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ */
      board.innerHTML = "";
      sortedHistory.forEach((h, index) => {
        const div = document.createElement("div");
        div.className = "item";
        div.style.animationDelay = `${0.1 * index}s`;

        div.innerHTML = `
          <strong>${h.name}</strong><br>
          äºˆæƒ³ï¼š${h.first} â†’ ${h.second} â†’ ${h.third}<br>

          <div class="rank-block">
            <strong>å®Ÿéš›ã®ç€é †</strong><br>
            1ç€ï¼š${actual1}<br>
            2ç€ï¼š${actual2}<br>
            3ç€ï¼š${actual3}<br>
          </div>

          <span class="${h.hit ? "hit" : "miss"}">
            ${h.hit ? "ğŸ‰ çš„ä¸­ï¼" : "âŒ ãƒã‚ºãƒ¬"}
          </span>
        `;

        board.appendChild(div);
      });

      /* âœ… ã‚¿ãƒƒãƒ—ã§æ®µéšå…¬é–‹ */
      setupTapReveal();
    }

    /* âœ… ã‚¿ãƒƒãƒ—ã§æ®µéšå…¬é–‹ */
    let step = 0;

    function setupTapReveal() {
      document.body.addEventListener("click", () => {
        step++;

        if (step === 1) {
          // âœ… æœ€åˆã®ã‚¿ãƒƒãƒ— â†’ è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦3ç€è¡¨ç¤º
          document.getElementById("rank3").classList.add("show");
          document.getElementById("correctBox").scrollIntoView({ behavior: "smooth" });
        }

        if (step === 2) {
          // âœ… 2å›ç›® â†’ 2ç€è¡¨ç¤º
          document.getElementById("rank2").classList.add("show");
        }

        if (step === 3) {
          // âœ… 3å›ç›® â†’ 1ç€è¡¨ç¤º
          document.getElementById("rank1").classList.add("show");
        }

        if (step === 4) {
          // âœ… 4å›ç›® â†’ çµæœä¸€è¦§ã‚’è¡¨ç¤º
          document.getElementById("resultBoard").style.display = "block";
          document.getElementById("resultBoard").scrollIntoView({ behavior: "smooth" });
        }
      });
    }

    /* âœ… Firestore ã® trifecta ã‚’å…¨å‰Šé™¤ */
    async function clearHistory() {
      if (!confirm("æœ¬å½“ã«å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

      const snap = await getDocs(trifectaCol);
      for (const d of snap.docs) {
        await deleteDoc(doc(db, "trifecta", d.id));
      }

      alert("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
      location.reload();
    }

    window.clearHistory = clearHistory;

    loadAllResults();
  </script>

</body>
</html>
