<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3é€£å˜ã‚²ãƒ¼ãƒ  - ãƒ›ãƒ¼ãƒ </title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b3d0b; /* èŠã®ã‚ˆã†ãªæ·±ã„ç·‘ */
      color: #fff;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 2.2em;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      margin-bottom: 20px;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .section {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      margin: 15px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      border: 2px solid #ffeb3b;
      box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
    }

    label {
      display: block;
      margin: 10px 0 5px;
      font-size: 1.1em;
      font-weight: bold;
    }

    input[type="number"] {
      width: 120px;
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 1.1em;
      text-align: center;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
    }

    button:hover {
      background: #fff176;
    }

    .player-card {
      background: #1b5e20;
      padding: 12px;
      margin: 10px auto;
      border-radius: 8px;
      width: 85%;
      max-width: 450px;
      border-left: 6px solid #ffeb3b;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
      font-size: 1.2em;
      text-align: left;
      padding-left: 20px;
    }

    a {
      color: #ffeb3b;
      text-decoration: none;
      font-weight: bold;
    }

    a:hover {
      text-decoration: underline;
    }

    #currentTotal {
      font-size: 1.6em;
      font-weight: bold;
      color: #ffeb3b;
    }
  </style>
</head>
<body>

  <h1>ğŸ‡ 3é€£å˜ã‚²ãƒ¼ãƒ </h1>

  <div class="section">
    <label>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°</label>
    <input type="number" id="playerCount" min="1" max="20" value="3">
    <button id="savePlayerCount">äººæ•°ã‚’ç¢ºå®š</button>
  </div>

  <div class="section">
    <label>åˆè¨ˆæ•°å­—ã®ä¸Šé™å€¤</label>
    <input type="number" id="maxTotal" min="1" value="100">
    <button id="saveMaxTotal">ä¸Šé™ã‚’ç¢ºå®š</button>
  </div>

  <div class="section">
    <p>ç¾åœ¨ã®åˆè¨ˆå€¤ï¼š<span id="currentTotal">-</span></p>
    <p id="maxTotalLabel"></p>
  </div>

  <div id="playerList"></div>

  <div class="section">
    <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼‰</button>
  </div>

  <script>
    const DEFAULT_VALUE = 5;
    const PLAYER_COUNT_KEY = "playerCount";
    const MAX_TOTAL_KEY = "maxTotal";

    /* ------------------------------
       å€¤ã®å–å¾—ãƒ»ä¿å­˜
    ------------------------------ */
    function getPlayerValue(playerId) {
      const key = "player_" + playerId + "_value";
      const stored = localStorage.getItem(key);
      return stored ? parseInt(stored, 10) : DEFAULT_VALUE;
    }

    function setPlayerValue(playerId, value) {
      const key = "player_" + playerId + "_value";
      localStorage.setItem(key, String(value));
    }

    /* ------------------------------
       è¨­å®šèª­ã¿è¾¼ã¿
    ------------------------------ */
    function loadSettings() {
      const storedCount = localStorage.getItem(PLAYER_COUNT_KEY);
      if (storedCount !== null) {
        document.getElementById("playerCount").value = storedCount;
      }

      const storedMax = localStorage.getItem(MAX_TOTAL_KEY);
      if (storedMax !== null) {
        document.getElementById("maxTotal").value = storedMax;
      }
    }

    /* ------------------------------
       ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ä¿å­˜
    ------------------------------ */
    function savePlayerCount() {
      const count = parseInt(document.getElementById("playerCount").value, 10);
      if (isNaN(count) || count < 1) {
        alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ã¯1ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      localStorage.setItem(PLAYER_COUNT_KEY, String(count));
      renderPlayers();
    }

    /* ------------------------------
       ä¸Šé™å€¤ä¿å­˜
    ------------------------------ */
    function saveMaxTotal() {
      const max = parseInt(document.getElementById("maxTotal").value, 10);
      if (isNaN(max) || max < 1) {
        alert("ä¸Šé™å€¤ã¯1ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      localStorage.setItem(MAX_TOTAL_KEY, String(max));
      updateTotalDisplay();
    }

    /* ------------------------------
       ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤º
    ------------------------------ */
    function renderPlayers() {
      const list = document.getElementById("playerList");
      list.innerHTML = "";

      const count = parseInt(localStorage.getItem(PLAYER_COUNT_KEY) || "3", 10);

      for (let i = 1; i <= count; i++) {
        const div = document.createElement("div");
        div.className = "player-card";
        div.innerHTML = `
          <strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}</strong><br>
          <a href="${i}.html" target="_blank">â–¶ è©³ç´°ãƒšãƒ¼ã‚¸ã¸</a>
        `;
        list.appendChild(div);
      }

      updateTotalDisplay();
    }

    /* ------------------------------
       åˆè¨ˆå€¤è¡¨ç¤º + ãƒšãƒŠãƒ«ãƒ†ã‚£å‡¦ç†
    ------------------------------ */
    function updateTotalDisplay() {
      const count = parseInt(localStorage.getItem(PLAYER_COUNT_KEY) || "3", 10);
      let total = 0;

      for (let i = 1; i <= count; i++) {
        total += getPlayerValue(i);
      }

      const currentTotalEl = document.getElementById("currentTotal");
      currentTotalEl.textContent = total;

      const maxTotal = parseInt(localStorage.getItem(MAX_TOTAL_KEY) || "100", 10);
      document.getElementById("maxTotalLabel").textContent = `ä¸Šé™ï¼š${maxTotal}`;

      currentTotalEl.style.color = total > maxTotal ? "red" : "#ffeb3b";

      /* âœ… ã“ã“ã‹ã‚‰ãƒšãƒŠãƒ«ãƒ†ã‚£å‡¦ç†ï¼ˆ1ä½ã®å€¤ã‚’åŠåˆ†ã«ã™ã‚‹ï¼‰ */
      if (total > maxTotal) {
        const values = [];
        for (let i = 1; i <= count; i++) {
          values.push({ id: i, value: getPlayerValue(i) });
        }

        // å€¤ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
        values.sort((a, b) => b.value - a.value);

        const topPlayer = values[0].id;
        const topValue = values[0].value;

        // âœ… åŠåˆ†ã«ã™ã‚‹ï¼ˆå°æ•°ç‚¹åˆ‡ã‚Šæ¨ã¦ï¼‰
        const newValue = Math.floor(topValue / 2);
        setPlayerValue(topPlayer, newValue);

        // âœ… èª°ãŒå¯¾è±¡ã‹ã¯ä¼ã›ã‚‹
        alert("âš  ä¸Šé™ã‚’è¶…ãˆãŸãŸã‚ã€ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ");

        // âœ… å†æç”»
        renderPlayers();
        return;
      }
      /* âœ… ãƒšãƒŠãƒ«ãƒ†ã‚£å‡¦ç†ã“ã“ã¾ã§ */
    }

    /* ------------------------------
       å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
    ------------------------------ */
    function resetAllPlayers() {
      if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      const count = parseInt(localStorage.getItem(PLAYER_COUNT_KEY) || "3", 10);

      for (let i = 1; i <= count; i++) {
        setPlayerValue(i, DEFAULT_VALUE);
      }

      localStorage.removeItem("trifecta_history");
      localStorage.removeItem("player_value_history");

      alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");

      renderPlayers();
      updateTotalDisplay();
    }

    /* ------------------------------
       ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    ------------------------------ */
    document.getElementById("savePlayerCount").addEventListener("click", savePlayerCount);
    document.getElementById("saveMaxTotal").addEventListener("click", saveMaxTotal);
    document.getElementById("resetBtn").addEventListener("click", resetAllPlayers);

    /* ------------------------------
       åˆæœŸè¡¨ç¤º
    ------------------------------ */
    loadSettings();
    renderPlayers();
  </script>

</body>
</html>
