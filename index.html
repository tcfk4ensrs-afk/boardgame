<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3é€£å˜ã‚²ãƒ¼ãƒ  - ãƒ›ãƒ¼ãƒ ï¼ˆFirebaseç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b3d0b;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    h1 {
      font-size: 2.2em;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      margin-bottom: 20px;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .section {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      margin: 15px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      border: 2px solid #ffeb3b;
      box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-size: 1.1em;
      font-weight: bold;
    }
    input[type="number"] {
      width: 120px;
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 1.1em;
      text-align: center;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
    }
    button:hover {
      background: #fff176;
    }
    .player-card {
      background: #1b5e20;
      padding: 12px;
      margin: 10px auto;
      border-radius: 8px;
      width: 85%;
      max-width: 450px;
      border-left: 6px solid #ffeb3b;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
      font-size: 1.2em;
      text-align: left;
      padding-left: 20px;
    }
    a {
      color: #ffeb3b;
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
    #currentTotal {
      font-size: 1.6em;
      font-weight: bold;
      color: #ffeb3b;
    }
  </style>
</head>
<body>

  <h1>ğŸ‡ 3é€£å˜ã‚²ãƒ¼ãƒ ï¼ˆFirebaseç‰ˆï¼‰</h1>

  <div class="section">
    <label>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°</label>
    <input type="number" id="playerCount" min="1" max="20">
    <button id="savePlayerCount">äººæ•°ã‚’ç¢ºå®š</button>
    <p id="playerCountDisplay" style="margin-top:10px;"></p>
  </div>

  <div class="section">
    <label>åˆè¨ˆæ•°å­—ã®ä¸Šé™å€¤</label>
    <input type="number" id="maxTotal" min="1">
    <button id="saveMaxTotal">ä¸Šé™ã‚’ç¢ºå®š</button>
    <p id="maxTotalDisplay" style="margin-top:10px;"></p>
  </div>

  <div class="section">
    <p>ç¾åœ¨ã®åˆè¨ˆå€¤ï¼š<span id="currentTotal">-</span></p>
    <p id="maxTotalLabel"></p>
  </div>

  <div id="playerList"></div>

  <div class="section">
    <button id="resetHistoryBtn">å±¥æ­´ã ã‘ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="resetBtn">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
  </div>

  <!-- âœ… Firebase SDK èª­ã¿è¾¼ã¿ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      onSnapshot, collection, addDoc, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* âœ… Firebase è¨­å®š */
    const firebaseConfig = {
      apiKey: "AIzaSyA60JGwkkQ4HbN6G7yPqhK_tPXFVE7GA0U",
      authDomain: "sanrentan-6adc0.firebaseapp.com",
      projectId: "sanrentan-6adc0",
      storageBucket: "sanrentan-6adc0.firebasestorage.app",
      messagingSenderId: "920208181022",
      appId: "1:920208181022:web:bb3a050055fb9a40782b0f",
      measurementId: "G-43N8MYJW96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* âœ… Firestore å‚ç…§ */
    const settingsRef = doc(db, "settings", "global");
    const playersCol = collection(db, "players");
    const historyCol = collection(db, "history");

    /* âœ… è¡¨ç¤ºæ›´æ–°é–¢æ•° */
    function updateSettingDisplays(playerCount, maxTotal) {
      document.getElementById("playerCountDisplay").textContent =
        `ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ï¼š${playerCount}äºº`;

      document.getElementById("maxTotalDisplay").textContent =
        `ç¾åœ¨ã®ä¸Šé™å€¤ï¼š${maxTotal}`;
    }

    /* âœ… Firestore è¨­å®šã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã‚€ */
    onSnapshot(settingsRef, (snap) => {
      if (!snap.exists()) return;

      const data = snap.data();

      document.getElementById("playerCount").value = data.playerCount;
      document.getElementById("maxTotal").value = data.maxTotal;

      updateSettingDisplays(data.playerCount, data.maxTotal);

      renderPlayers(data.playerCount);
      updateTotalDisplay();
    });

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤º */
    async function renderPlayers(count) {
      const list = document.getElementById("playerList");
      list.innerHTML = "";

      for (let i = 1; i <= count; i++) {
        const div = document.createElement("div");
        div.className = "player-card";
        div.innerHTML = `
          <strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}</strong><br>
          <a href="${i}.html" target="_blank">â–¶ è©³ç´°ãƒšãƒ¼ã‚¸ã¸</a>
        `;
        list.appendChild(div);
      }
    }

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤å–å¾— */
    async function getPlayerValue(id) {
      const ref = doc(db, "players", String(id));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data().value : 5;
    }

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤ä¿å­˜ */
    async function setPlayerValue(id, value) {
      await setDoc(doc(db, "players", String(id)), { value });
    }

    /* âœ… å±¥æ­´ä¿å­˜ */
    async function saveHistory(player, before, after, penalty) {
      await addDoc(historyCol, {
        player,
        before,
        after,
        diff: after - before,
        time: new Date().toLocaleString(),
        penalty
      });
    }

    /* âœ… åˆè¨ˆå€¤è¡¨ç¤º + ãƒšãƒŠãƒ«ãƒ†ã‚£å‡¦ç† */
    async function updateTotalDisplay() {
      const settingsSnap = await getDoc(settingsRef);
      if (!settingsSnap.exists()) return;

      const { playerCount, maxTotal } = settingsSnap.data();

      let total = 0;
      const values = [];

      for (let i = 1; i <= playerCount; i++) {
        const v = await getPlayerValue(i);
        values.push({ id: i, value: v });
        total += v;
      }

      document.getElementById("currentTotal").textContent = total;
      document.getElementById("maxTotalLabel").textContent = `ä¸Šé™ï¼š${maxTotal}`;

      /* âœ… ãƒšãƒŠãƒ«ãƒ†ã‚£ç™ºå‹• */
      if (total > maxTotal) {
        values.sort((a, b) => b.value - a.value);
        const top = values[0];

        const before = top.value;
        const after = Math.floor(before / 2);

        await setPlayerValue(top.id, after);
        await saveHistory(top.id, before, after, true);

        alert("âš  ä¸Šé™ã‚’è¶…ãˆãŸãŸã‚ã€ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ");
      }
    }

    /* âœ… è¨­å®šä¿å­˜ï¼ˆäººæ•°ï¼‰ */
    document.getElementById("savePlayerCount").onclick = async () => {
      const count = Number(document.getElementById("playerCount").value);
      await updateDoc(settingsRef, { playerCount: count });
      updateSettingDisplays(count, Number(document.getElementById("maxTotal").value));
    };

    /* âœ… è¨­å®šä¿å­˜ï¼ˆä¸Šé™ï¼‰ */
    document.getElementById("saveMaxTotal").onclick = async () => {
      const max = Number(document.getElementById("maxTotal").value);
      await updateDoc(settingsRef, { maxTotal: max });
      updateSettingDisplays(Number(document.getElementById("playerCount").value), max);
    };

    /* âœ… å±¥æ­´ã ã‘ãƒªã‚»ãƒƒãƒˆ */
    document.getElementById("resetHistoryBtn").onclick = async () => {
      if (!confirm("å±¥æ­´ã ã‘ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

      const historySnap = await getDocs(historyCol);
      for (const d of historySnap.docs) {
        await deleteDoc(doc(db, "history", d.id));
      }

      alert("å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    };

    /* âœ… å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ */
    document.getElementById("resetBtn").onclick = async () => {
      if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

      const settingsSnap = await getDoc(settingsRef);
      const count = settingsSnap.data().playerCount;

      // âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤ã‚’åˆæœŸåŒ–
      for (let i = 1; i <= count; i++) {
        await setPlayerValue(i, 5);
      }

      // âœ… history ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨å‰Šé™¤
      const historySnap = await getDocs(historyCol);
      for (const d of historySnap.docs) {
        await deleteDoc(doc(db, "history", d.id));
      }

      alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    };
  </script>

</body>
</html>
