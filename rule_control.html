<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ«ãƒ¼ãƒ«å¹²æ¸‰ï¼ˆå€¤åŠæ¸›ãƒãƒ£ãƒ³ã‚¹ + è¨ˆç®— + ãƒ•ã‚£ãƒ«ã‚¿ï¼‰</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b3d0b;
      color: #fff;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 2em;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      margin-bottom: 20px;
    }

    .section {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 450px;
      border: 2px solid #ffeb3b;
      box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
    }

    label {
      display: block;
      margin-top: 15px;
      font-size: 1.2em;
    }

    input, select {
      width: 80%;
      padding: 10px;
      font-size: 1.2em;
      border-radius: 8px;
      border: none;
      margin-top: 8px;
      text-align: center;
    }

    button {
      margin-top: 25px;
      padding: 12px 25px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
    }

    .success-anim {
      font-size: 1.6em;
      color: #ffeb3b;
      margin-top: 20px;
      opacity: 0;
      animation: pop 1s forwards;
      text-shadow: 0 0 15px #ffeb3b;
    }

    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .fail-msg {
      font-size: 1.4em;
      color: #ff5252;
      margin-top: 20px;
      opacity: 0;
      animation: fadeIn 0.8s forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .result-box {
      margin-top: 15px;
      font-size: 1.2em;
      color: #ffeb3b;
    }
  </style>
</head>
<body>

  <h1>ğŸ¯ ãƒ«ãƒ¼ãƒ«å¹²æ¸‰ãƒšãƒ¼ã‚¸</h1>

  <!-- âœ… å€¤åŠæ¸›ãƒãƒ£ãƒ³ã‚¹ -->
  <div class="section">
    <h2>å€¤åŠæ¸›ãƒãƒ£ãƒ³ã‚¹</h2>

    <label>å¯¾è±¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</label>
    <select id="playerSelect"></select>

    <label>å½“ã¦ã‚‹æ•°å­—ï¼ˆ1ã€œ100ï¼‰</label>
    <input type="number" id="guessNumber" min="1" max="100">

    <button id="applyBtn">åˆ¤å®šã™ã‚‹</button>

    <div id="resultArea"></div>
  </div>

  <!-- âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2äººã®è¨ˆç®— -->
  <div class="section">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨ˆç®—ï¼ˆå’Œãƒ»å·®ãƒ»ç©ï¼‰</h2>

    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼A</label>
    <select id="calcA"></select>

    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼B</label>
    <select id="calcB"></select>

    <button id="calcBtn">è¨ˆç®—ã™ã‚‹</button>

    <div id="calcResult" class="result-box"></div>
  </div>

  <!-- âœ… æŒ‡å®šå€¤ã‚ˆã‚Šå¤§ãã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ -->
  <div class="section">
    <h2>å€¤ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæŒ‡å®šå€¤ã‚ˆã‚Šå¤§ãã„ï¼‰</h2>

    <label>ã—ãã„å€¤</label>
    <input type="number" id="filterValue" min="1">

    <button id="filterBtn">æ¤œç´¢ã™ã‚‹</button>

    <div id="filterResult" class="result-box"></div>
  </div>

  <!-- âœ… Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, addDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* âœ… Firebase è¨­å®š */
    const firebaseConfig = {
      apiKey: "AIzaSyA60JGwkkQ4HbN6G7yPqhK_tPXFVE7GA0U",
      authDomain: "sanrentan-6adc0.firebaseapp.com",
      projectId: "sanrentan-6adc0",
      storageBucket: "sanrentan-6adc0.firebasestorage.app",
      messagingSenderId: "920208181022",
      appId: "1:920208181022:web:bb3a050055fb9a40782b0f",
      measurementId: "G-43N8MYJW96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const settingsRef = doc(db, "settings", "global");
    const playersCol = collection(db, "players");
    const historyCol = collection(db, "history");

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã‚’ä½œæˆ */
    async function loadPlayers() {
      const snap = await getDoc(settingsRef);
      if (!snap.exists()) return;

      const count = snap.data().playerCount;

      const selects = ["playerSelect", "calcA", "calcB"];
      selects.forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = "";
        for (let i = 1; i <= count; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`;
          sel.appendChild(opt);
        }
      });
    }

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤å–å¾— */
    async function getPlayerValue(id) {
      const ref = doc(db, "players", String(id));
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data().value : 5;
    }

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å€¤ä¿å­˜ */
    async function setPlayerValue(id, value) {
      await setDoc(doc(db, "players", String(id)), { value });
    }

    /* âœ… å±¥æ­´ä¿å­˜ */
    async function saveHistory(player, before, after) {
      await addDoc(historyCol, {
        player,
        before,
        after,
        diff: after - before,
        time: new Date().toLocaleString(),
        penalty: false
      });
    }

    /* âœ… å€¤åŠæ¸›ãƒãƒ£ãƒ³ã‚¹ */
    document.getElementById("applyBtn").onclick = async () => {
      const playerId = Number(document.getElementById("playerSelect").value);
      const guess = Number(document.getElementById("guessNumber").value);
      const resultArea = document.getElementById("resultArea");
      resultArea.innerHTML = "";

      if (!guess || guess < 1 || guess > 100) {
        alert("1ã€œ100 ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const correctNumber = Math.floor(Math.random() * 100) + 1;

      if (guess === correctNumber) {
        const before = await getPlayerValue(playerId);
        const after = Math.floor(before / 2);

        await setPlayerValue(playerId, after);
        await saveHistory(playerId, before, after);

        resultArea.innerHTML = `
          <div class="success-anim">ğŸ‰ æˆåŠŸï¼å€¤ãŒåŠåˆ†ã«ãªã‚Šã¾ã—ãŸï¼</div>
          <p>æ­£è§£ï¼š${correctNumber}</p>
        `;
      } else {
        resultArea.innerHTML = `
          <div class="fail-msg">âŒ å¤±æ•—ï¼</div>
          <p>æ­£è§£ï¼š${correctNumber}</p>
        `;
      }
    };

    /* âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2äººã®è¨ˆç®— */
    document.getElementById("calcBtn").onclick = async () => {
      const a = Number(document.getElementById("calcA").value);
      const b = Number(document.getElementById("calcB").value);

      const vA = await getPlayerValue(a);
      const vB = await getPlayerValue(b);

      const result = `
        å’Œï¼š${vA + vB}<br>
        å·®ï¼š${vA - vB}<br>
        ç©ï¼š${vA * vB}
      `;

      document.getElementById("calcResult").innerHTML = result;
    };

    /* âœ… æŒ‡å®šå€¤ã‚ˆã‚Šå¤§ãã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ */
    document.getElementById("filterBtn").onclick = async () => {
      const threshold = Number(document.getElementById("filterValue").value);
      const resultBox = document.getElementById("filterResult");
      resultBox.innerHTML = "";

      if (!threshold) {
        alert("ã—ãã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const players = await getDocs(playersCol);
      const list = [];

      players.forEach(doc => {
        const id = Number(doc.id);
        const value = doc.data().value;
        if (value > threshold) {
          list.push(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${id}ï¼ˆ${value}ï¼‰`);
        }
      });

      resultBox.innerHTML =
        list.length > 0
          ? list.join("<br>")
          : "è©²å½“ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚";
    };

    loadPlayers();
  </script>

</body>
</html>
