<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3é€£å˜çµæœ</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b3d0b;
      color: #fff;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 2em;
      color: #ffeb3b;
      text-shadow: 0 0 10px #ffeb3b;
      margin-bottom: 20px;
    }

    .result-box {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 450px;
      border: 2px solid #ffeb3b;
      box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
      font-size: 1.3em;
    }

    .rank-line {
      font-size: 1.6em;
      margin: 10px 0;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease-out;
    }

    .rank-line.show {
      opacity: 1;
      transform: translateY(0);
    }

    .hit {
      color: #ffeb3b;
      font-size: 1.8em;
      margin-top: 20px;
      animation: blink 1s infinite;
    }

    .miss {
      color: #ff5252;
      font-size: 1.8em;
      margin-top: 20px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    .history-box {
      margin-top: 30px;
      background: rgba(0,0,0,0.4);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #fff;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .history-item {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
      text-align: left;
    }

    .history-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>

  <h1>ğŸ‡ 3é€£å˜ çµæœ</h1>

  <div class="result-box" id="resultArea"></div>

  <div class="history-box" id="historyArea">
    <h2>ğŸ“œ éå»ã®çµæœ</h2>
    <div id="historyList"></div>
  </div>

  <script>
    function getPlayerValue(id) {
      const v = localStorage.getItem("player_" + id + "_value");
      return v ? parseInt(v, 10) : 5;
    }

    function loadResult() {
      const data = JSON.parse(localStorage.getItem("trifecta"));
      if (!data) {
        document.getElementById("resultArea").innerHTML = "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      const { name, first, second, third } = data;

      // å®Ÿéš›ã®é †ä½ã‚’è¨ˆç®—
      const count = parseInt(localStorage.getItem("playerCount") || "3", 10);
      const values = [];
      for (let i = 1; i <= count; i++) {
        values.push({ id: i, value: getPlayerValue(i) });
      }

      values.sort((a, b) => b.value - a.value);

      const actual1 = values[0].id;
      const actual2 = values[1].id;
      const actual3 = values[2].id;

      const hit =
        first == actual1 &&
        second == actual2 &&
        third == actual3;

      // é›»å…‰æ²ç¤ºæ¿é¢¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      document.getElementById("resultArea").innerHTML = `
        <p><strong>åå‰ï¼š</strong> ${name}</p>

        <div class="rank-line" id="line1">1ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual1}</div>
        <div class="rank-line" id="line2">2ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual2}</div>
        <div class="rank-line" id="line3">3ç€ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${actual3}</div>

        <p class="${hit ? "hit" : "miss"}" id="hitMsg">
          ${hit ? "ğŸ‰ çš„ä¸­ï¼" : "æ®‹å¿µâ€¦"}
        </p>
      `;

      setTimeout(() => document.getElementById("line1").classList.add("show"), 300);
      setTimeout(() => document.getElementById("line2").classList.add("show"), 800);
      setTimeout(() => document.getElementById("line3").classList.add("show"), 1300);

      // å±¥æ­´ä¿å­˜
      saveHistory({
        name,
        first,
        second,
        third,
        actual1,
        actual2,
        actual3,
        hit
      });

      loadHistory();
    }

    function saveHistory(entry) {
      const history = JSON.parse(localStorage.getItem("trifecta_history") || "[]");
      history.push(entry);
      localStorage.setItem("trifecta_history", JSON.stringify(history));
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem("trifecta_history") || "[]");
      const list = document.getElementById("historyList");
      list.innerHTML = "";

      history.slice().reverse().forEach(h => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <strong>${h.name}</strong><br>
          äºˆæƒ³ï¼š${h.first} â†’ ${h.second} â†’ ${h.third}<br>
          çµæœï¼š${h.actual1} â†’ ${h.actual2} â†’ ${h.actual3}<br>
          ${h.hit ? "ğŸ‰ çš„ä¸­" : "âŒ ãƒã‚ºãƒ¬"}
        `;
        list.appendChild(div);
      });
    }

    loadResult();
  </script>

</body>
</html>
