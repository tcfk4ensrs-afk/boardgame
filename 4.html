<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b3d0b;
      color: #fff;
      padding: 20px;
      text-align: center;
    }

    .player-badge {
      display: inline-block;
      background: #ffeb3b;
      color: #000;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 1.6em;
      font-weight: bold;
      margin-bottom: 20px;
      box-shadow: 0 0 10px #ffeb3b;
    }

    .value-box {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      margin: 15px auto;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      border: 2px solid #ffeb3b;
      box-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
      font-size: 1.3em;
    }

    #currentValue {
      font-size: 2em;
      color: #ffeb3b;
      font-weight: bold;
    }

    #currentRank {
      font-size: 1.5em;
      color: #ffeb3b;
      font-weight: bold;
      margin-top: 10px;
      text-shadow: 0 0 8px #ffeb3b;
    }

    .btn-area {
      margin-top: 20px;
    }

    button {
      margin: 8px;
      padding: 12px 20px;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ffeb3b;
    }

    button:disabled {
      background: #777;
      color: #333;
      box-shadow: none;
      cursor: not-allowed;
    }

    .closing-msg {
      margin-top: 20px;
      font-size: 1.1em;
      color: #ffeb3b;
      display: none;
    }
  </style>
</head>
<body>

  <div class="player-badge">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ 4</div>

  <div class="value-box">
    <p>ç¾åœ¨ã®å€¤ï¼š</p>
    <div id="currentValue">-</div>

    <p>é †ä½ï¼š</p>
    <div id="currentRank">-</div>
  </div>

  <!-- ğŸ”¢ ãƒœã‚¿ãƒ³å¤‰æ›´æ¸ˆã¿ -->
  <div class="btn-area">
    <button data-diff="-11">-11</button>
    <button data-diff="-3">-3</button>
    <button data-diff="-1">-1</button>
    <button data-diff="2">+2</button>
    <button data-diff="4">+4</button>
    <button data-diff="10">+10</button>
  </div>

  <div class="closing-msg" id="closingMsg">
    å…¥åŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚5ç§’å¾Œã«ã‚¿ãƒ–ã‚’é–‰ã˜ã¾ã™â€¦
  </div>

  <!-- â–¼ LocalStorage å±¥æ­´è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="value-box" style="margin-top:30px;">
    <p>ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ï¼ˆå…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…±é€šï¼‰</p>
    <div id="localHistory"></div>
  </div>

  <script type="module">
    /* Firebase SDK èª­ã¿è¾¼ã¿ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      onSnapshot, collection, addDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* Firebase è¨­å®š */
    const firebaseConfig = {
      apiKey: "AIzaSyA60JGwkkQ4HbN6G7yPqhK_tPXFVE7GA0U",
      authDomain: "sanrentan-6adc0.firebaseapp.com",
      projectId: "sanrentan-6adc0",
      storageBucket: "sanrentan-6adc0.firebasestorage.app",
      messagingSenderId: "920208181022",
      appId: "1:920208181022:web:bb3a050055fb9a40782b0f",
      measurementId: "G-43N8MYJW96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ID */
    const PLAYER_ID = 4;

    /* Firestore å‚ç…§ */
    const playerRef = doc(db, "players", String(PLAYER_ID));
    const settingsRef = doc(db, "settings", "global");
    const historyCol = collection(db, "history");

    /* Firestore ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å€¤ã‚’å–å¾— */
    onSnapshot(playerRef, (snap) => {
      if (snap.exists()) {
        document.getElementById("currentValue").textContent = snap.data().value;
        calcRank();
      }
    });

    /* é †ä½è¨ˆç®— */
    async function calcRank() {
      const settingsSnap = await getDoc(settingsRef);
      if (!settingsSnap.exists()) return;

      const playerCount = settingsSnap.data().playerCount;
      const values = [];

      for (let i = 1; i <= playerCount; i++) {
        const snap = await getDoc(doc(db, "players", String(i)));
        values.push(snap.exists() ? snap.data().value : 5);
      }

      const mySnap = await getDoc(playerRef);
      const myValue = mySnap.exists() ? mySnap.data().value : 5;

      const sorted = [...values].sort((a, b) => b - a);
      const rank = sorted.indexOf(myValue) + 1;

      document.getElementById("currentRank").textContent =
        `${rank} ä½ / ${playerCount} äºº`;
    }

    /* Firebase å±¥æ­´ä¿å­˜ */
    async function saveHistory(before, after, diff) {
      await addDoc(historyCol, {
        player: PLAYER_ID,
        before,
        after,
        diff,
        time: new Date().toLocaleString(),
        penalty: false
      });
    }

    /* LocalStorage å±¥æ­´ä¿å­˜ï¼ˆå…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…±é€šï¼‰ */
    function saveLocalHistory(playerId, before, after, diff) {
      const list = JSON.parse(localStorage.getItem("history_all_players") || "[]");

      list.push({
        player: playerId,
        time: new Date().toLocaleString(),
        before,
        after,
        diff
      });

      localStorage.setItem("history_all_players", JSON.stringify(list));
    }

    /* LocalStorage å±¥æ­´è¡¨ç¤º */
    function renderLocalHistory() {
      const area = document.getElementById("localHistory");
      const list = JSON.parse(localStorage.getItem("history_all_players") || "[]");

      if (list.length === 0) {
        area.innerHTML = "<p>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      area.innerHTML = list.map(item => `
        <div style="border-bottom:1px solid #666; padding:5px 0;">
          <strong>${item.time}</strong><br>
          ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${item.player}ï¼š ${item.before} â†’ ${item.after}ï¼ˆ${item.diff > 0 ? "+" : ""}${item.diff}ï¼‰
        </div>
      `).join("");
    }

    /* ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ– */
    function disableButtons() {
      document.querySelectorAll("button[data-diff]").forEach(btn => {
        btn.disabled = true;
      });
    }

    /* ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ */
    function scheduleCloseTab() {
      document.getElementById("closingMsg").style.display = "block";

      setTimeout(() => {
        window.open('', '_self');
        window.close();
      }, 5000);
    }

    /* å€¤å¤‰æ›´å‡¦ç† */
    async function onButtonClick(diff) {
      disableButtons();

      const snap = await getDoc(playerRef);
      const before = snap.exists() ? snap.data().value : 5;
      const after = before + diff;

      await setDoc(playerRef, { value: after });
      await saveHistory(before, after, diff);
      saveLocalHistory(PLAYER_ID, before, after, diff);  // â† è¿½åŠ 

      renderLocalHistory(); // â† ç”»é¢æ›´æ–°

      scheduleCloseTab();
    }

    /* ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² */
    document.querySelectorAll("button[data-diff]").forEach(btn => {
      btn.addEventListener("click", () => {
        const diff = parseInt(btn.getAttribute("data-diff"), 10);
        onButtonClick(diff);
      });
    });

    /* åˆæœŸè¡¨ç¤º */
    calcRank();
    renderLocalHistory();
  </script>

</body>
</html>
